<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"
    />
    <title>Happiness Journal</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Happiness" />

    <!-- Theme Color -->
    <meta name="theme-color" content="#1A1A1A" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Newsreader:ital,wght@0,300;0,400;1,300&family=Courier+Prime:wght@400;700&display=swap");

      @font-face {
        font-family: "Neue Haas Grotesk";
        src: url("/Users/jazulynn/Downloads/Neue Haas Grotesk Collection/NeueHaasDisplayRoman.ttf")
          format("truetype");
        font-weight: 400;
        font-style: normal;
      }

      @font-face {
        font-family: "Neue Haas Grotesk";
        src: url("/Users/jazulynn/Downloads/Neue Haas Grotesk Collection/NeueHaasDisplayMediu.ttf")
          format("truetype");
        font-weight: 500;
        font-style: normal;
      }

      @font-face {
        font-family: "Neue Haas Grotesk";
        src: url("/Users/jazulynn/Downloads/Neue Haas Grotesk Collection/NeueHaasDisplayBold.ttf")
          format("truetype");
        font-weight: 600;
        font-style: normal;
      }

      :root {
        --color-bg: #f5f5f5;
        --color-surface: #ffffff;
        --color-text: #1a1a1a;
        --color-text-secondary: #8e8e93;
        --color-text-tertiary: #c7c7cc;
        --color-accent: #007aff;
        --color-danger: #ff3b30;

        --pink: #efc6c5;
        --yellow: #efce7b;
        --pistachio: #cbd183;
        --green: #7cbe59;
        --blue: #b7d8fe;
        --purple: #d3c2cd;
        --magenta: #d17089;
        --white: #ffffff;

        --radius-sm: 12px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --radius-xl: 32px;

        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.08);

        --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      html {
        overflow-x: hidden;
        max-width: 100vw;
      }

      body {
        font-family: "Neue Haas Grotesk", "Inter", -apple-system,
          BlinkMacSystemFont, sans-serif;
        background: var(--color-bg);
        color: var(--color-text);
        overflow-x: hidden;
        max-width: 100vw;
        position: relative;
        min-height: 100vh;
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* Top Bar - Minimal */
      .top-bar {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(245, 245, 245, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        padding: calc(env(safe-area-inset-top) + 32px) 24px 0 24px;
        height: calc(84px + env(safe-area-inset-top));
        display: flex;
        align-items: center;
      }

      .top-bar-content {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      .top-bar h1 {
        font-family: "Neue Haas Grotesk", "Inter", -apple-system,
          BlinkMacSystemFont, sans-serif;
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.5px;
        color: var(--color-text);
      }

      .categories-btn {
        background: none;
        border: none;
        color: var(--color-text);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s var(--ease-out);
        opacity: 0;
        transform: scale(0.9);
        pointer-events: none;
        position: absolute;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .categories-btn.visible {
        opacity: 1;
        transform: scale(1);
        pointer-events: all;
      }

      .categories-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      .categories-btn svg {
        width: 24px;
        height: 24px;
      }

      .add-btn {
        background: none;
        border: none;
        color: var(--color-text);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s var(--ease-out);
        position: absolute;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .add-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      .add-btn svg {
        width: 24px;
        height: 24px;
      }

      .settings-btn {
        position: fixed;
        bottom: calc(32px + env(safe-area-inset-bottom));
        right: 24px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 0.5px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        color: var(--color-text);
        cursor: pointer;
        transition: all 0.3s var(--spring);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .settings-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.16);
      }

      .settings-btn:active {
        transform: scale(0.95);
      }

      .settings-btn svg {
        width: 24px;
        height: 24px;
      }

      .settings-btn.has-api-key {
        background: rgba(0, 122, 255, 0.1);
        border-color: rgba(0, 122, 255, 0.3);
      }

      .settings-btn.has-api-key svg {
        color: var(--color-accent);
      }

      /* Main Container */
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 32px 24px 120px;
      }

      /* Empty State */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        opacity: 0;
        animation: fadeIn 0.8s var(--ease-out) 0.2s forwards;
      }

      .empty-state-icon {
        width: 80px;
        height: 80px;
        margin-bottom: 24px;
        opacity: 0.3;
      }

      .empty-state h2 {
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.5px;
        margin-bottom: 8px;
        color: var(--color-text);
      }

      .empty-state p {
        font-size: 16px;
        color: var(--color-text-secondary);
        font-weight: 400;
      }

      /* Grid Layout */
      .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        opacity: 0;
        animation: fadeIn 0.8s var(--ease-out) 0.1s forwards;
      }

      /* Post-it Card */
      .post-it {
        border-radius: var(--radius-md);
        padding: 20px;
        background: var(--yellow);
        position: relative;
        cursor: pointer;
        transition: transform 0.3s var(--spring),
          box-shadow 0.3s var(--ease-out);
        box-shadow: var(--shadow-sm);
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        animation: cardIn 0.6s var(--spring) forwards;
        height: 200px;
        display: flex;
        flex-direction: column;
      }

      .post-it:nth-child(1) {
        animation-delay: 0.1s;
      }
      .post-it:nth-child(2) {
        animation-delay: 0.15s;
      }
      .post-it:nth-child(3) {
        animation-delay: 0.2s;
      }
      .post-it:nth-child(4) {
        animation-delay: 0.25s;
      }
      .post-it:nth-child(5) {
        animation-delay: 0.3s;
      }
      .post-it:nth-child(6) {
        animation-delay: 0.35s;
      }
      .post-it:nth-child(n + 7) {
        animation-delay: 0.4s;
      }

      .post-it:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
      }

      .post-it:active {
        transform: scale(0.98);
      }

      .post-it-image {
        width: calc(100% + 40px);
        margin: -20px -20px 12px -20px;
        height: 120px;
        object-fit: cover;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        flex-shrink: 0;
      }

      .post-it-text {
        font-family: "Newsreader", Georgia, serif;
        font-size: 15px;
        line-height: 1.6;
        color: rgba(0, 0, 0, 0.85);
        font-weight: 400;
        flex: 1;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        text-overflow: ellipsis;
        min-height: 0;
      }

      .post-it-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: rgba(0, 0, 0, 0.4);
        font-weight: 500;
        margin-bottom: 12px;
        flex-shrink: 0;
      }

      .post-it-category {
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.2px;
        color: rgba(0, 0, 0, 0.6);
      }

      /* FAB Button - Hidden */
      .fab {
        display: none;
      }

      /* Modal Overlay */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0);
        z-index: 2000;
        display: none;
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
        transition: background 0.4s var(--ease-out),
          backdrop-filter 0.4s var(--ease-out);
      }

      .modal-overlay.active {
        display: block;
        background: transparent;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      /* Bottom Sheet Modal */
      .modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #e8e8e8;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 2001;
        transform: translateY(100%);
        transition: transform 0.5s var(--spring);
        padding-bottom: env(safe-area-inset-bottom);
      }

      .modal-overlay.active .modal {
        transform: translateY(0);
      }

      .modal-handle {
        width: 36px;
        height: 5px;
        background: var(--color-text-tertiary);
        border-radius: 3px;
        margin: 12px auto 8px;
      }

      .modal-header {
        padding: 8px 20px 20px;
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #e8e8e8;
      }

      @media (max-width: 400px) {
        .modal-header {
          padding: 8px 16px 16px;
        }
      }

      .modal-title {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: -0.5px;
        color: var(--color-text);
      }

      .header-save-btn {
        background: none;
        border: none;
        color: var(--color-text);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s var(--ease-out);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .header-save-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      .header-save-btn svg {
        width: 20px;
        height: 20px;
      }

      .delete-btn {
        width: 100%;
        max-width: 100%;
        padding: 14px;
        background: #fee2e2;
        color: #dc2626;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s var(--ease-out);
        display: none;
        margin-top: 20px;
        box-sizing: border-box;
      }

      @media (max-width: 400px) {
        .delete-btn {
          padding: 12px;
          font-size: 15px;
          margin-top: 16px;
        }
      }

      .delete-btn.visible {
        display: block;
      }

      .delete-btn:hover {
        background: #fecaca;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .delete-btn:active {
        transform: scale(0.98);
      }

      .modal-content {
        padding: 20px;
        max-width: 100%;
        overflow-x: hidden;
      }

      @media (max-width: 400px) {
        .modal-content {
          padding: 16px;
        }
      }

      /* Note Preview */
      .note-preview {
        background: var(--yellow);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 20px;
        min-height: 280px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        transition: background 0.3s var(--ease-out);
        position: relative;
        overflow: hidden;
        border: 6px solid white;
      }

      @media (max-width: 400px) {
        .note-preview {
          padding: 16px;
          margin-bottom: 16px;
          border: 4px solid white;
        }
      }

      .note-preview::before {
        content: "";
        position: absolute;
        inset: 0;
        background: url('data:image/svg+xml,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)" opacity="0.03"/></svg>');
        pointer-events: none;
        opacity: 0.5;
      }

      .preview-image {
        width: calc(100% + 48px);
        height: 200px;
        object-fit: cover;
        border-radius: var(--radius-md);
        margin: -24px -24px 16px -24px;
      }

      .note-preview textarea {
        background: transparent;
        border: none;
        font-family: "Newsreader", Georgia, serif;
        font-size: 17px;
        line-height: 1.6;
        color: rgba(0, 0, 0, 0.85);
        resize: none;
        width: 100%;
        min-height: 200px;
        outline: none;
        position: relative;
        z-index: 1;
      }

      .note-preview textarea::placeholder {
        color: rgba(0, 0, 0, 0.3);
        font-style: italic;
        font-weight: 300;
      }

      /* Controls */
      .controls-container {
        background: white;
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        max-width: 100%;
        width: 100%;
        min-width: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      @media (max-width: 400px) {
        .controls-container {
          padding: 16px;
        }
      }

      .control-section {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .control-section:last-of-type {
        margin-bottom: 0;
      }

      @media (max-width: 400px) {
        .control-section {
          margin-bottom: 16px;
        }
      }

      .control-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        display: block;
      }

      @media (max-width: 400px) {
        .control-label {
          font-size: 11px;
          margin-bottom: 8px;
        }
      }

      /* Date Input */
      .date-input {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        padding: 10px 8px;
        background: var(--color-bg);
        border: 1px solid var(--color-text-tertiary);
        border-radius: var(--radius-sm);
        font-family: "Inter", sans-serif;
        font-size: 14px;
        color: var(--color-text);
        cursor: pointer;
        transition: all 0.2s var(--ease-out);
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        flex-shrink: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      @media (max-width: 400px) {
        .date-input {
          padding: 8px 6px;
          font-size: 13px;
        }
      }

      @media (max-width: 360px) {
        .date-input {
          padding: 8px 4px;
          font-size: 12px;
        }
      }

      /* iOS date picker specific fixes */
      .date-input::-webkit-date-and-time-value {
        text-align: center;
        min-width: 0;
        max-width: 100%;
      }

      .date-input::-webkit-datetime-edit {
        min-width: 0;
        max-width: 100%;
        padding: 0;
      }

      .date-input::-webkit-datetime-edit-fields-wrapper {
        min-width: 0;
        max-width: 100%;
      }

      .date-input:hover {
        border-color: var(--color-accent);
      }

      .date-input:focus {
        outline: none;
        border-color: var(--color-accent);
        background: rgba(0, 122, 255, 0.04);
      }

      .color-picker {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-start;
      }

      .color-option {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s var(--spring);
        position: relative;
        flex-shrink: 0;
        aspect-ratio: 1 / 1;
      }

      .color-option::after {
        content: "";
        position: absolute;
        inset: -6px;
        border-radius: 50%;
        border: 2px solid currentColor;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s var(--spring);
      }

      .color-option:hover {
        transform: scale(1.15);
      }

      .color-option.selected {
        transform: scale(1.1);
      }

      .color-option.selected::after {
        opacity: 0.3;
        transform: scale(1);
      }

      /* Image Upload */
      .image-upload-btn {
        width: 100%;
        max-width: 100%;
        padding: 14px;
        background: var(--color-bg);
        border: 2px dashed var(--color-text-tertiary);
        border-radius: var(--radius-sm);
        color: var(--color-text-secondary);
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s var(--ease-out);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-sizing: border-box;
      }

      @media (max-width: 400px) {
        .image-upload-btn {
          padding: 12px;
          font-size: 14px;
        }
      }

      @media (max-width: 360px) {
        .image-upload-btn {
          padding: 10px;
          font-size: 13px;
        }
      }

      .image-upload-btn:hover {
        border-color: var(--color-accent);
        color: var(--color-accent);
        background: rgba(0, 122, 255, 0.04);
      }

      .image-upload-btn input {
        display: none;
      }

      /* Save Button */
      .save-btn {
        flex: 1;
        padding: 16px;
        background: var(--color-text);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s var(--ease-out);
      }

      .save-btn:hover {
        background: #0062cc;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .save-btn:active {
        transform: scale(0.98);
      }

      .save-btn:disabled {
        background: var(--color-text-tertiary);
        cursor: not-allowed;
        transform: none;
      }

      .save-btn.full-width {
        width: 100%;
      }

      /* Categories Modal */
      .categories-content {
        padding: 0 24px 40px;
      }

      .category-group {
        margin-bottom: 32px;
      }

      .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }

      .category-name {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: -0.3px;
      }

      .category-count {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-accent);
        background: rgba(0, 122, 255, 0.1);
        padding: 4px 12px;
        border-radius: 12px;
      }

      .category-summary {
        background: rgba(0, 0, 0, 0.03);
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        font-size: 14px;
        line-height: 1.6;
        color: var(--color-text-secondary);
        font-style: italic;
      }

      .categories-legend {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
      }

      .categories-legend h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--color-text);
      }

      .legend-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--color-text-secondary);
      }

      .legend-emoji {
        font-size: 18px;
        width: 24px;
        text-align: center;
      }

      .legend-name {
        font-weight: 500;
        color: var(--color-text);
      }

      /* Animations */
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      @keyframes cardIn {
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* View Overlay - Centered Modal */
      #viewModal .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        right: auto;
        bottom: auto;
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
        max-width: 500px;
        width: 90%;
        border-radius: var(--radius-xl);
        padding: 0;
        max-height: 90vh;
        overflow-y: auto;
        background: white;
      }

      #viewModal.active .modal {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        transition: all 0.3s var(--ease-out);
      }

      .view-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 24px 24px 20px;
        background: white;
      }

      .view-modal-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--color-text);
        letter-spacing: -0.5px;
      }

      .edit-icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: transparent;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s var(--ease-out);
      }

      .edit-icon-btn:hover {
        transform: scale(1.1);
        background: rgba(0, 0, 0, 0.05);
      }

      .edit-icon-btn svg {
        color: var(--color-text);
        stroke: var(--color-text);
      }

      .view-post-it-container {
        padding: 0 24px 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: white;
      }

      .view-image-section {
        border: 8px solid white;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        cursor: pointer;
        transition: transform 0.2s var(--ease-out);
      }

      .view-image-section:hover {
        transform: scale(1.02);
      }

      .view-post-it {
        background: var(--yellow);
        border-radius: var(--radius-lg);
        padding: 20px;
        position: relative;
        min-height: 250px;
        max-height: 450px;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-sm);
        border: 1px solid transparent;
      }

      .view-post-it.white-note {
        border: 1px solid #f3f4f6;
      }

      .view-post-it::before {
        content: "";
        position: absolute;
        inset: 0;
        background: url('data:image/svg+xml,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)" opacity="0.03"/></svg>');
        pointer-events: none;
        opacity: 0.5;
        border-radius: var(--radius-lg);
      }

      .view-post-it-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .view-post-it-date {
        font-size: 12px;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.5);
      }

      .view-post-it-category {
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .view-post-it-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
        display: block;
      }

      .view-post-it-content {
        flex: 1;
        overflow-y: auto;
        position: relative;
        z-index: 1;
      }

      .view-note-text {
        font-family: "Newsreader", Georgia, serif;
        font-size: 17px;
        line-height: 1.6;
        color: rgba(0, 0, 0, 0.85);
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--color-text-tertiary);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--color-text-secondary);
      }

      /* Settings Modal */
      .settings-content {
        padding: 0 24px 40px;
      }

      .settings-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
      }

      .settings-section h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--color-text);
      }

      .settings-section p {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-bottom: 16px;
        line-height: 1.5;
      }

      .settings-input {
        width: 100%;
        padding: 14px 16px;
        background: var(--color-bg);
        border: 1px solid var(--color-text-tertiary);
        border-radius: var(--radius-sm);
        font-family: "Courier Prime", monospace;
        font-size: 13px;
        color: var(--color-text);
        transition: all 0.2s var(--ease-out);
        margin-bottom: 12px;
      }

      .settings-input:focus {
        outline: none;
        border-color: var(--color-accent);
        background: rgba(0, 122, 255, 0.04);
      }

      .settings-input::placeholder {
        color: var(--color-text-tertiary);
      }

      .api-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 8px;
        margin-top: 12px;
      }

      .api-status.connected {
        background: rgba(52, 199, 89, 0.1);
        color: #34c759;
      }

      .api-status.disconnected {
        background: rgba(255, 59, 48, 0.1);
        color: #ff3b30;
      }

      .api-status svg {
        width: 16px;
        height: 16px;
      }

      .settings-btn-group {
        display: flex;
        gap: 12px;
      }

      .secondary-btn {
        flex: 1;
        padding: 14px;
        background: var(--color-bg);
        color: var(--color-text);
        border: 1px solid var(--color-text-tertiary);
        border-radius: var(--radius-sm);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s var(--ease-out);
      }

      .secondary-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        border-color: var(--color-text);
      }

      .primary-btn {
        flex: 1;
        padding: 14px;
        background: var(--color-text);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s var(--ease-out);
      }

      .primary-btn:hover {
        background: #0062cc;
        transform: translateY(-1px);
      }

      .info-box {
        background: rgba(0, 122, 255, 0.05);
        border-left: 3px solid var(--color-accent);
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
      }

      .info-box p {
        font-size: 13px;
        color: var(--color-text-secondary);
        margin: 0;
        line-height: 1.6;
      }

      .info-box a {
        color: var(--color-accent);
        text-decoration: none;
        font-weight: 600;
      }

      .info-box a:hover {
        text-decoration: underline;
      }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-content">
        <button
          class="categories-btn"
          id="categoriesBtn"
          onclick="showCategories()"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </button>
        <h1>What makes me happy</h1>
        <button class="add-btn" onclick="openModal()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container">
      <!-- Empty State -->
      <div id="emptyState" class="empty-state">
        <svg
          class="empty-state-icon"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
          ></path>
        </svg>
        <h2>Your story begins</h2>
        <p>Capture moments that bring you joy</p>
      </div>

      <!-- Grid -->
      <div id="grid" class="grid" style="display: none"></div>
    </div>

    <!-- FAB -->
    <button class="fab" onclick="openModal()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 4v16m8-8H4"
        ></path>
      </svg>
    </button>

    <!-- Floating Settings Button -->
    <button class="settings-btn" id="settingsBtn" onclick="openSettings()">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="12" cy="12" r="3"></circle>
        <path
          d="M12 1v6m0 6v6m5.2-13.2-4.2 4.2m-4.2 4.2L4.6 18.4M23 12h-6m-6 0H5m13.2 5.2-4.2-4.2m-4.2-4.2L5.6 4.6"
        ></path>
      </svg>
    </button>

    <!-- View Note Modal -->
    <div
      id="viewModal"
      class="modal-overlay"
      onclick="handleOverlayClick(event)"
    >
      <div class="modal">
        <div class="view-modal-header">
          <h2 class="view-modal-title">Your moment</h2>
          <button class="edit-icon-btn" onclick="enterEditMode()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
              ></path>
            </svg>
          </button>
        </div>
        <div class="view-post-it-container">
          <!-- Image Section -->
          <div
            class="view-image-section"
            id="viewImageSection"
            style="display: none"
            onclick="viewFullImage()"
          >
            <img id="viewImage" class="view-post-it-image" />
          </div>

          <!-- Post-it with Date, Tag, and Text -->
          <div class="view-post-it" id="viewPostIt">
            <div class="view-post-it-header">
              <div class="view-post-it-date" id="viewDate"></div>
              <div class="view-post-it-category" id="viewCategory"></div>
            </div>
            <div class="view-post-it-content">
              <div class="view-note-text" id="viewNoteText"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Entry Modal -->
    <div
      id="addModal"
      class="modal-overlay"
      onclick="handleOverlayClick(event)"
    >
      <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">New moment</h2>
          <button class="header-save-btn" onclick="saveEntry()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
              ></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save
          </button>
        </div>
        <div class="modal-content">
          <div class="note-preview" id="notePreview">
            <img
              id="previewImage"
              class="preview-image"
              style="display: none"
            />
            <textarea
              id="entryText"
              placeholder="What brought you joy today?"
            ></textarea>
          </div>

          <div class="controls-container">
            <div class="control-section">
              <label class="control-label">Date</label>
              <input type="date" id="dateInput" class="date-input" />
            </div>

            <div class="control-section">
              <label class="control-label">Note color</label>
              <div class="color-picker">
                <div
                  class="color-option"
                  style="background: #efc6c5"
                  onclick="selectColor('#EFC6C5')"
                ></div>
                <div
                  class="color-option selected"
                  style="background: #efce7b"
                  onclick="selectColor('#EFCE7B')"
                ></div>
                <div
                  class="color-option"
                  style="background: #cbd183"
                  onclick="selectColor('#CBD183')"
                ></div>
                <div
                  class="color-option"
                  style="background: #7cbe59"
                  onclick="selectColor('#7cbe59')"
                ></div>
                <div
                  class="color-option"
                  style="background: #b7d8fe"
                  onclick="selectColor('#b7d8fe')"
                ></div>
                <div
                  class="color-option"
                  style="background: #d3c2cd"
                  onclick="selectColor('#D3C2CD')"
                ></div>
                <div
                  class="color-option"
                  style="background: #d17089"
                  onclick="selectColor('#d17089')"
                ></div>
                <div
                  class="color-option"
                  style="background: #ffffff; border: 2px solid #e0e0e0"
                  onclick="selectColor('#FFFFFF')"
                ></div>
              </div>
            </div>

            <div class="control-section">
              <label class="control-label">Image</label>
              <label class="image-upload-btn">
                <svg
                  width="20"
                  height="20"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <span id="imageUploadText">Add image</span>
                <input
                  type="file"
                  accept="image/*"
                  onchange="handleImageUpload(event)"
                />
              </label>
            </div>

            <button class="delete-btn" id="deleteBtn" onclick="deleteEntry()">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Categories Modal -->
    <div
      id="categoriesModal"
      class="modal-overlay"
      onclick="handleOverlayClick(event)"
    >
      <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header">
          <h2 class="modal-title">Your patterns</h2>
        </div>
        <div id="categoriesContent" class="categories-content"></div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="modal-overlay"
      onclick="handleOverlayClick(event)"
    >
      <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-header">
          <h2 class="modal-title">Settings</h2>
        </div>
        <div class="settings-content">
          <div class="settings-section">
            <h3>Claude AI Integration</h3>
            <p>
              Connect Claude API to unlock intelligent categorization and
              personalized insights that evolve with your entries.
            </p>

            <input
              type="password"
              id="apiKeyInput"
              class="settings-input"
              placeholder="sk-ant-api03-..."
              autocomplete="off"
              spellcheck="false"
            />

            <div class="settings-btn-group">
              <button class="secondary-btn" onclick="clearApiKey()">
                Remove
              </button>
              <button class="primary-btn" onclick="saveApiKey()">
                Save API Key
              </button>
            </div>

            <div
              id="apiStatus"
              class="api-status disconnected"
              style="display: none"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              <span id="apiStatusText">Not connected</span>
            </div>

            <div class="info-box">
              <p><strong>What you get with AI:</strong></p>
              <p>
                • Smart value-based categorization (Love & Connection, Growth &
                Mastery, etc.)
              </p>
              <p>
                • Dynamic insights that reference your actual entries and people
                you mention
              </p>
              <p>• Pattern recognition that evolves as you journal more</p>
              <p style="margin-top: 12px">
                Get your API key at
                <a href="https://console.anthropic.com/" target="_blank"
                  >console.anthropic.com</a
                >
              </p>
              <p style="margin-top: 8px; font-size: 12px; opacity: 0.7">
                Your API key is stored locally on your device and never shared.
                Each categorization/insight costs ~$0.001.
              </p>
            </div>
          </div>

          <div class="settings-section">
            <h3>Cloud Sync (Firebase)</h3>
            <p>
              Sync your entries across devices and never lose your data. Your
              journal is private and encrypted.
            </p>

            <input
              type="text"
              id="firebaseApiKey"
              class="settings-input"
              placeholder="Firebase API Key"
              autocomplete="off"
              spellcheck="false"
            />

            <input
              type="text"
              id="firebaseProjectId"
              class="settings-input"
              placeholder="Firebase Project ID"
              autocomplete="off"
              spellcheck="false"
            />

            <div class="settings-btn-group">
              <button class="secondary-btn" onclick="clearFirebaseConfig()">
                Remove
              </button>
              <button class="primary-btn" onclick="saveFirebaseConfig()">
                Save & Sync
              </button>
            </div>

            <div
              id="firebaseStatus"
              class="api-status disconnected"
              style="display: none"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              <span>Not syncing</span>
            </div>

            <div class="info-box">
              <p><strong>How to set up Firebase (free):</strong></p>
              <p>
                1. Go to
                <a href="https://console.firebase.google.com" target="_blank"
                  >console.firebase.google.com</a
                >
              </p>
              <p>2. Create a new project (or use existing)</p>
              <p>3. Enable Firestore Database</p>
              <p>4. Go to Project Settings → General</p>
              <p>5. Copy your API Key and Project ID</p>
              <p style="margin-top: 8px; font-size: 12px; opacity: 0.7">
                Your data is end-to-end encrypted and only you can access it.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // State
      let entries = [];
      let selectedColor = "#F3E874";
      let selectedImage = null;
      let editingId = null;
      let viewingId = null;
      let apiKey = localStorage.getItem("claudeApiKey") || null;

      // Firebase state
      let db = null;
      let auth = null;
      let currentUser = null;
      let unsubscribeSnapshot = null;
      let firebaseConfig =
        JSON.parse(localStorage.getItem("firebaseConfig")) || null;

      // Firebase Functions
      async function initializeFirebase(config) {
        try {
          const firebaseApp = firebase.initializeApp({
            apiKey: config.apiKey,
            authDomain: `${config.projectId}.firebaseapp.com`,
            projectId: config.projectId,
          });

          auth = firebase.auth();
          db = firebase.firestore();

          // Sign in anonymously
          const userCred = await auth.signInAnonymously();
          currentUser = userCred.user;

          // Start listening for changes
          startFirebaseSync();

          updateFirebaseStatus(true);
          return true;
        } catch (error) {
          console.error("Firebase initialization error:", error);
          updateFirebaseStatus(false);
          return false;
        }
      }

      function startFirebaseSync() {
        if (!db || !currentUser) return;

        // Listen to real-time updates
        unsubscribeSnapshot = db
          .collection(`users/${currentUser.uid}/entries`)
          .onSnapshot((snapshot) => {
            const firebaseEntries = [];
            snapshot.forEach((doc) => {
              const data = doc.data();
              // Ensure the entry has all required fields including id
              if (data && data.id && data.text) {
                firebaseEntries.push(data);
              }
            });

            // Only update if we have entries or if entries array is empty
            // This prevents race conditions during save
            if (firebaseEntries.length > 0 || entries.length === 0) {
              // Update local entries
              entries = firebaseEntries.sort(
                (a, b) => new Date(a.date) - new Date(b.date)
              );

              // Also save to localStorage as backup
              localStorage.setItem("happinessEntries", JSON.stringify(entries));

              renderEntries();
              updateCategoriesButton();
            }
          });
      }

      async function saveEntryToFirebase(entry) {
        if (!db || !currentUser) {
          // Fallback to localStorage
          return saveToLocalStorage(entry);
        }

        try {
          const docRef = db
            .collection(`users/${currentUser.uid}/entries`)
            .doc(entry.id.toString());
          await docRef.set(entry);
          return true;
        } catch (error) {
          console.error("Error saving to Firebase:", error);
          // Fallback to localStorage
          return saveToLocalStorage(entry);
        }
      }

      async function deleteEntryFromFirebase(entryId) {
        if (!db || !currentUser) {
          // Fallback to localStorage
          return deleteFromLocalStorage(entryId);
        }

        try {
          await db
            .collection(`users/${currentUser.uid}/entries`)
            .doc(entryId.toString())
            .delete();
          return true;
        } catch (error) {
          console.error("Error deleting from Firebase:", error);
          return deleteFromLocalStorage(entryId);
        }
      }

      function saveToLocalStorage(entry) {
        try {
          const existingIndex = entries.findIndex((e) => e.id === entry.id);
          if (existingIndex !== -1) {
            entries[existingIndex] = entry;
          } else {
            entries.push(entry);
          }
          entries.sort((a, b) => new Date(a.date) - new Date(b.date));
          localStorage.setItem("happinessEntries", JSON.stringify(entries));
          return true;
        } catch (error) {
          if (error.name === "QuotaExceededError") {
            throw new Error(
              "Storage quota exceeded. Please remove images from old notes to free up space."
            );
          }
          throw error;
        }
      }

      function deleteFromLocalStorage(entryId) {
        entries = entries.filter((e) => e.id !== entryId);
        localStorage.setItem("happinessEntries", JSON.stringify(entries));
        return true;
      }

      function saveFirebaseConfig() {
        const apiKey = document.getElementById("firebaseApiKey").value.trim();
        const projectId = document
          .getElementById("firebaseProjectId")
          .value.trim();

        if (!apiKey || !projectId) {
          alert("Please enter both Firebase API Key and Project ID");
          return;
        }

        const config = { apiKey, projectId };
        firebaseConfig = config;
        localStorage.setItem("firebaseConfig", JSON.stringify(config));

        initializeFirebase(config).then((success) => {
          if (success) {
            alert(
              "✅ Firebase connected!\n\nYour journal is now syncing to the cloud."
            );
          } else {
            alert(
              "❌ Failed to connect to Firebase\n\nPlease check your credentials."
            );
          }
        });
      }

      function clearFirebaseConfig() {
        if (
          confirm(
            "Remove Firebase sync?\n\nYour data will stay on this device but won't sync to cloud."
          )
        ) {
          if (unsubscribeSnapshot) {
            unsubscribeSnapshot();
          }
          firebaseConfig = null;
          localStorage.removeItem("firebaseConfig");
          document.getElementById("firebaseApiKey").value = "";
          document.getElementById("firebaseProjectId").value = "";
          updateFirebaseStatus(false);
        }
      }

      function updateFirebaseStatus(connected) {
        const status = document.getElementById("firebaseStatus");
        status.style.display = "flex";

        if (connected) {
          status.className = "api-status connected";
          status.innerHTML = `
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <span>Syncing to cloud</span>
                `;
        } else {
          status.className = "api-status disconnected";
          status.innerHTML = `
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                  </svg>
                  <span>Not syncing</span>
                `;
        }
      }

      // Claude API Integration
      async function callClaudeAPI(prompt, systemPrompt = "") {
        if (!apiKey) return null;

        try {
          const response = await fetch(
            "https://api.anthropic.com/v1/messages",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-api-key": apiKey,
                "anthropic-version": "2023-06-01",
              },
              body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 500,
                system: systemPrompt,
                messages: [
                  {
                    role: "user",
                    content: prompt,
                  },
                ],
              }),
            }
          );

          if (!response.ok) {
            console.error("Claude API error:", response.status);
            return null;
          }

          const data = await response.json();
          return data.content[0].text;
        } catch (error) {
          console.error("Error calling Claude API:", error);
          return null;
        }
      }

      async function categorizewithAI(text) {
        const systemPrompt = `You are a happiness journal categorization assistant. You categorize journal entries into VALUE-BASED categories that capture the emotional need being fulfilled, not the surface activity.

      Available categories:
      - Love & Connection: Intimacy, quality time with partner, romance, closeness
      - Belonging & Community: Family, friends, home, being part of something, togetherness
      - Growth & Mastery: Learning, accomplishment, progress, skill development
      - Presence & Wonder: Mindfulness, beauty, gratitude, awe
      - Creative Expression: Making, building, designing, creating
      - Vitality & Strength: Physical activity, energy, fitness
      - Sanctuary & Ease: Rest, peace, comfort, relaxation
      - Purpose & Contribution: Helping others, making a difference, meaningful work
      - Celebration & Joy: Fun, laughter, play, celebration
      - Self-Discovery: Insight, authenticity, self-awareness
      - Care & Generosity: Giving, thoughtfulness, treating others
      - Culinary Pleasure: Delicious food experiences, savoring meals
      - Stories & Narrative: Movies, books, shows, narrative experiences
      - Simple Pleasures: Small everyday joys like coffee, walks, sunshine

      Instructions:
      - Tag the FEELING/VALUE, not the activity
      - Example: "watched a movie with my husband" → "Love & Connection" (not "Stories & Narrative")
      - Example: "went home for dinner with family" → "Belonging & Community" (not "Culinary Pleasure")
      - Focus on WHY it brought joy, not WHAT the activity was

      Respond with ONLY the category name, nothing else.`;

        const prompt = `Categorize this journal entry:\n\n"${text}"`;

        const category = await callClaudeAPI(prompt, systemPrompt);
        return category ? category.trim() : null;
      }

      async function generateInsightWithAI(
        category,
        categoryEntries,
        allEntries
      ) {
        const systemPrompt = `You are a warm, insightful friend analyzing someone's happiness journal to help them see patterns in what brings them joy.

      Tone:
      - Warm and understanding, like a close friend
      - Direct and specific, not therapy-speak
      - 1-2 sentences maximum
      - Use periods, not dashes
      - Reference actual details from their entries (people's names, specific activities, places)

      Philosophy:
      - Focus on the WHY (emotional need) not the WHAT (activity)
      - Tag feelings and values, not surface behaviors
      - Make them feel heard and understood
      - Show them patterns they might not have noticed

      Rules:
      - FIRST ENTRY in a category: Simple, direct insight about what this reveals
      - MULTIPLE ENTRIES: Show the pattern emerging, use phrases like "keeps showing up", "whether... or..."
      - Extract and use real names from entries (capitalize properly)
      - Be specific to their actual entries, not generic
      - No fluff or filler words`;

        const entryTexts = categoryEntries.map((e) => e.text).join("\n- ");
        const prompt = `Category: ${category}
      Number of entries: ${categoryEntries.length}
      Is first entry: ${categoryEntries.length === 1 ? "yes" : "no"}

      Entries in this category:
      - ${entryTexts}

      Generate a personalized insight (1-2 sentences) that shows what this pattern reveals about what brings them joy:`;

        const insight = await callClaudeAPI(prompt, systemPrompt);
        return insight ? insight.trim() : null;
      }

      // Settings Functions
      function openSettings() {
        const input = document.getElementById("apiKeyInput");
        if (apiKey) {
          input.value = apiKey;
          updateApiStatus(true);
        } else {
          input.value = "";
          updateApiStatus(false);
        }
        document.getElementById("settingsModal").classList.add("active");
      }

      function saveApiKey() {
        const input = document.getElementById("apiKeyInput");
        const key = input.value.trim();

        if (key) {
          apiKey = key;
          localStorage.setItem("claudeApiKey", key);
          updateApiStatus(true);
          updateSettingsButton();
          alert(
            "✅ API key saved!\n\nYour future entries will use Claude AI for smarter categorization and personalized insights."
          );
        } else {
          alert("Please enter an API key");
        }
      }

      function clearApiKey() {
        if (
          confirm(
            "Remove Claude API key?\n\nYou'll fall back to keyword-based categorization."
          )
        ) {
          apiKey = null;
          localStorage.removeItem("claudeApiKey");
          document.getElementById("apiKeyInput").value = "";
          updateApiStatus(false);
          updateSettingsButton();
        }
      }

      function updateApiStatus(connected) {
        const status = document.getElementById("apiStatus");

        status.style.display = "flex";

        if (connected) {
          status.className = "api-status connected";
          status.innerHTML = `
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                              <polyline points="22 4 12 14.01 9 11.01"></polyline>
                          </svg>
                          <span>Connected to Claude AI</span>
                      `;
        } else {
          status.className = "api-status disconnected";
          status.innerHTML = `
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <circle cx="12" cy="12" r="10"></circle>
                              <line x1="15" y1="9" x2="9" y2="15"></line>
                              <line x1="9" y1="9" x2="15" y2="15"></line>
                          </svg>
                          <span>Not connected</span>
                      `;
        }
      }

      function updateSettingsButton() {
        const btn = document.getElementById("settingsBtn");
        if (apiKey) {
          btn.classList.add("has-api-key");
        } else {
          btn.classList.remove("has-api-key");
        }
      }

      // Value-Based Categories (tag the feeling, not the action)
      const categoryKeywords = {
        "Love & Connection": [
          "husband",
          "wife",
          "partner",
          "boyfriend",
          "girlfriend",
          "date",
          "together",
          "with my",
          "quality time",
          "intimate",
          "close",
          "cuddle",
          "kiss",
          "romance",
          "love",
        ],
        "Belonging & Community": [
          "family",
          "mom",
          "dad",
          "sister",
          "brother",
          "friend",
          "friends",
          "home",
          "belong",
          "helper",
          "celebrate",
          "celebrated",
          "birthday",
          "visit",
          "visited",
          "gathering",
          "together with",
          "reunion",
        ],
        "Growth & Mastery": [
          "learned",
          "figured out",
          "solved",
          "breakthrough",
          "understand",
          "finally",
          "accomplished",
          "achieved",
          "completed",
          "finished",
          "mastered",
          "progress",
          "better at",
          "improved",
          "goal",
        ],
        "Presence & Wonder": [
          "noticed",
          "beautiful",
          "amazing",
          "gorgeous",
          "stunning",
          "peaceful",
          "calm",
          "moment",
          "present",
          "grateful",
          "appreciate",
          "wonder",
          "awe",
          "mindful",
          "aware",
        ],
        "Creative Expression": [
          "created",
          "made",
          "built",
          "designed",
          "drew",
          "painted",
          "wrote",
          "photography",
          "project",
          "idea",
          "build",
          "building",
          "craft",
          "express",
          "create",
        ],
        "Vitality & Strength": [
          "run",
          "ran",
          "workout",
          "exercise",
          "gym",
          "strong",
          "energy",
          "energized",
          "powerful",
          "fit",
          "alive",
          "yoga",
          "training",
          "physical",
          "body",
        ],
        "Sanctuary & Ease": [
          "rest",
          "relax",
          "peaceful",
          "quiet",
          "calm",
          "cozy",
          "comfort",
          "safe",
          "bed",
          "sleep",
          "nap",
          "unwind",
          "ease",
          "sanctuary",
          "peace",
        ],
        "Purpose & Contribution": [
          "helped",
          "made a difference",
          "impact",
          "meaningful",
          "purpose",
          "contribute",
          "serve",
          "support",
          "give",
          "volunteer",
          "mentor",
          "teach",
          "share",
        ],
        "Celebration & Joy": [
          "celebrate",
          "celebrated",
          "party",
          "fun",
          "laugh",
          "laughed",
          "joy",
          "happy",
          "excited",
          "delight",
          "playful",
          "play",
          "funny",
          "hilarious",
        ],
        "Self-Discovery": [
          "realized",
          "understand myself",
          "insight",
          "reflection",
          "aware",
          "authentic",
          "true to",
          "discovered",
          "know myself",
          "clarity",
          "breakthrough",
        ],
        "Care & Generosity": [
          "bought for",
          "gift",
          "surprise",
          "treated",
          "care",
          "caring",
          "thoughtful",
          "generous",
          "helped",
          "support",
          "gave",
        ],
        "Culinary Pleasure": [
          "delicious",
          "tasty",
          "amazing food",
          "best meal",
          "favorite dish",
          "incredible",
          "yummy",
          "ramen",
          "sushi",
          "pasta",
        ],
        "Stories & Narrative": [
          "watched",
          "movie",
          "show",
          "series",
          "book",
          "read",
          "story",
          "episode",
          "film",
        ],
        "Simple Pleasures": [
          "coffee",
          "tea",
          "walk",
          "walking",
          "sunshine",
          "weather",
          "simple",
          "small",
          "little things",
        ],
      };

      const categoryEmojis = {
        // New value-based categories
        "love & connection": "💕",
        "belonging & community": "👨‍👩‍👧‍👦",
        "growth & mastery": "💪",
        "presence & wonder": "✨",
        "creative expression": "🎨",
        "vitality & strength": "🏃‍♀️",
        "sanctuary & ease": "🏡",
        "purpose & contribution": "🎯",
        "celebration & joy": "🎉",
        "self-discovery": "🌱",
        "care & generosity": "💝",
        "culinary pleasure": "🍜",
        "stories & narrative": "📖",
        "simple pleasures": "☕",

        // Backward compatibility for old category names
        "friends & social": "👨‍👩‍👧‍👦",
        "family time": "👨‍👩‍👧‍👦",
        "love & romance": "💕",
        "food & dining": "🍜",
        "coffee & tea": "☕",
        "pets & animals": "🐾",
        "health & fitness": "🏃‍♀️",
        "rest & sleep": "🏡",
        "nature & outdoors": "🌳",
        "weather & seasons": "☀️",
        "reading & books": "📖",
        music: "🎵",
        "movies & tv": "📖",
        gaming: "🎮",
        "art & creativity": "🎨",
        "learning & growth": "💪",
        "work & career": "💼",
        achievements: "🏆",
        "travel & adventure": "✈️",
        shopping: "💝",
        "laughter & fun": "🎉",
        "self care": "💆",
        "home & comfort": "🏡",
        "everyday joy": "✨",
      };

      function getCategoryEmoji(category) {
        return categoryEmojis[category.toLowerCase()] || "✨";
      }

      async function categorizeEntry(text) {
        // Try AI categorization first if API key is available
        if (apiKey) {
          const aiCategory = await categorizewithAI(text);
          if (aiCategory) {
            return aiCategory;
          }
        }

        // Fallback to keyword-based categorization
        const lower = text.toLowerCase();
        for (const [category, keywords] of Object.entries(categoryKeywords)) {
          if (keywords.some((kw) => lower.includes(kw))) {
            return category;
          }
        }
        return "Simple Pleasures";
      }

      async function generateCategorySummary(category, entries) {
        // Try AI insight generation first if API key is available
        if (apiKey) {
          const aiInsight = await generateInsightWithAI(
            category,
            entries,
            entries
          );
          if (aiInsight) {
            return aiInsight;
          }
        }

        // Fallback to template-based insights
        return generateTemplateBasedSummary(category, entries);
      }

      function generateTemplateBasedSummary(category, entries) {
        const count = entries.length;
        const catLower = category.toLowerCase();

        // Get specific person names mentioned
        const extractName = (text) => {
          const matches = text.match(/\b([A-Z][a-z]+(?:'s)?)\b/g);
          return matches
            ? matches.filter(
                (m) =>
                  ![
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                  ].includes(m)
              )
            : [];
        };

        const allNames = entries.flatMap((e) => extractName(e.text));
        const uniqueNames = [
          ...new Set(allNames.map((n) => n.replace("'s", ""))),
        ];
        const partnerName =
          uniqueNames.find((n) =>
            entries.some(
              (e) =>
                e.text.toLowerCase().includes("husband") ||
                e.text.toLowerCase().includes("wife") ||
                e.text.toLowerCase().includes("partner")
            )
          ) || null;

        // Analyze all texts together
        const allText = entries.map((e) => e.text.toLowerCase()).join(" ");

        // Extract key themes and details
        const has = {
          partner:
            allText.includes("husband") ||
            allText.includes("wife") ||
            allText.includes("partner"),
          friends: allText.includes("friend"),
          family:
            allText.includes("family") ||
            allText.includes("mom") ||
            allText.includes("dad") ||
            allText.includes("sister") ||
            allText.includes("brother"),
          helper: allText.includes("helper"),
          home: allText.includes("home"),
          dinner: allText.includes("dinner"),
          celebrated:
            allText.includes("celebrated") || allText.includes("birthday"),
          watched: allText.includes("watch"),
          made:
            allText.includes("made") ||
            allText.includes("built") ||
            allText.includes("created"),
          bought: allText.includes("bought"),
          went: allText.includes("went"),
          happy: allText.includes("happy"),
          working: allText.includes("working") || allText.includes("work"),
        };

        // Generate insight based on category and content
        let insight = "";

        // FIRST ENTRY - Simple, direct insight
        if (count === 1) {
          const entry = entries[0];
          const text = entry.text.toLowerCase();

          if (catLower.includes("love") || catLower.includes("connection")) {
            if (has.watched && partnerName) {
              insight = `Time with ${partnerName} brings you pure joy. These simple moments together are what matter most.`;
            } else if (has.partner) {
              insight = `Closeness with your partner fills you up. You find joy in the everyday moments of being together.`;
            } else {
              insight = `Connection lights you up. Being with someone who matters brings genuine happiness.`;
            }
          } else if (
            catLower.includes("belonging") ||
            catLower.includes("community")
          ) {
            if (has.friends) {
              insight = `You light up around friends. Shared experiences and time together energize you.`;
            } else if (has.celebrated && has.helper) {
              insight = `You find joy in honoring the people who support you. Celebrating your helper shows how you value care that goes both ways.`;
            } else if (has.family) {
              insight = `Family connection fills your cup. Being with the people who know you best brings comfort and joy.`;
            } else if (has.home) {
              insight = `Home represents belonging. Going back to familiar places and people recharges you.`;
            } else {
              insight = `You find joy in belonging. Being part of something bigger than yourself matters to you.`;
            }
          } else if (
            catLower.includes("care") ||
            catLower.includes("generosity")
          ) {
            insight = `Showing care for others brings you happiness. You find meaning in thoughtful gestures and celebration.`;
          } else if (
            catLower.includes("culinary") ||
            catLower.includes("food")
          ) {
            if (has.home && has.dinner) {
              insight = `Home-cooked meals represent comfort and connection. Food brings you joy when shared with others.`;
            } else {
              insight = `Food is more than sustenance. You savor the experience and the moments around the table.`;
            }
          } else if (
            catLower.includes("growth") ||
            catLower.includes("mastery")
          ) {
            insight = `You love proving to yourself what you're capable of. Accomplishment brings genuine pride.`;
          } else if (catLower.includes("creative")) {
            insight = `Creating something meaningful energizes you. Bringing ideas to life feels like purpose in action.`;
          } else if (
            catLower.includes("vitality") ||
            catLower.includes("strength")
          ) {
            insight = `Moving your body makes you feel alive. Physical accomplishment reminds you of your power.`;
          } else if (
            catLower.includes("sanctuary") ||
            catLower.includes("ease")
          ) {
            insight = `Rest isn't lazy. You recharge best when you give yourself permission to slow down.`;
          } else if (
            catLower.includes("celebration") ||
            catLower.includes("joy")
          ) {
            insight = `Playfulness lights you up. You know how to honor moments and find delight in the everyday.`;
          } else {
            insight = `This moment reflects something that matters to you. ${catLower} brings genuine happiness.`;
          }
        }
        // SUBSEQUENT ENTRIES - Show the pattern
        else {
          if (catLower.includes("love") || catLower.includes("connection")) {
            if (has.watched && has.dinner && partnerName) {
              insight = `Time with ${partnerName} keeps showing up as pure joy. Whether sharing meals or watching movies together, these everyday moments of closeness are what matter most.`;
            } else if (has.partner) {
              const activities = [];
              if (has.watched) activities.push("watching movies");
              if (has.dinner) activities.push("sharing meals");
              if (has.made) activities.push("creating together");
              const actStr =
                activities.length > 0
                  ? activities.slice(0, 2).join(" or ")
                  : "being";
              insight = `Intimacy keeps showing up as ${count} moments of ${actStr} together. You find joy in simple shared experiences with your partner.`;
            } else {
              insight = `Connection continues to light you up. These ${count} moments show that closeness with others brings genuine happiness.`;
            }
          } else if (
            catLower.includes("belonging") ||
            catLower.includes("community")
          ) {
            const people = [];
            if (has.friends) people.push("friends");
            if (has.family) people.push("family");
            if (has.helper) people.push("the people you care for");

            if (has.home && has.dinner) {
              insight = `Home keeps showing up as where connection happens. Whether celebrating birthdays or having dinner, togetherness around food brings you joy.`;
            } else if (people.length > 1) {
              insight = `Belonging shows up through ${people
                .slice(0, 2)
                .join(
                  " and "
                )}. These ${count} moments reveal that community and togetherness fill your cup.`;
            } else if (has.celebrated) {
              insight = `Another moment of honoring relationships. You find joy in celebrating others and showing you care.`;
            } else {
              insight = `Connection through community keeps lighting you up. These ${count} moments of togetherness bring genuine happiness.`;
            }
          } else if (
            catLower.includes("care") ||
            catLower.includes("generosity")
          ) {
            insight = `Generosity continues to bring you joy. Whether celebrating, giving, or showing thoughtfulness, caring for others lights you up.`;
          } else if (
            catLower.includes("culinary") ||
            catLower.includes("food")
          ) {
            if (has.home) {
              insight = `Food keeps showing up as connection. Whether at home or celebrating, meals bring you joy when shared with people you care about.`;
            } else {
              insight = `Another moment of savoring food. You appreciate the experience beyond just eating.`;
            }
          } else if (
            catLower.includes("growth") ||
            catLower.includes("mastery")
          ) {
            insight = `Accomplishment continues to energize you. These ${count} moments show that pushing yourself and achieving goals brings genuine pride.`;
          } else if (catLower.includes("creative")) {
            insight = `Creating things keeps lighting you up. Whether building, designing, or making, bringing ideas to life feels meaningful.`;
          } else if (
            catLower.includes("vitality") ||
            catLower.includes("strength")
          ) {
            insight = `Physical energy continues to bring joy. Movement reminds you that you're alive and capable.`;
          } else if (
            catLower.includes("stories") ||
            catLower.includes("narrative")
          ) {
            insight = `Stories keep pulling you in. Getting lost in narratives brings escape and emotional connection.`;
          } else if (catLower.includes("simple")) {
            insight = `Life's small moments keep showing up. These ${count} everyday joys remind you that happiness doesn't have to be grand.`;
          } else {
            insight = `${catLower} continues to bring you joy. These ${count} moments reveal a pattern of what truly lights you up.`;
          }
        }

        return insight;
      }

      async function init() {
        // Load entries from localStorage first
        const saved = localStorage.getItem("happinessEntries");
        if (saved) {
          entries = JSON.parse(saved);
        }

        // Set today as default date
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("dateInput").value = today;

        renderEntries();
        updateCategoriesButton();
        updateSettingsButton();

        // Initialize Firebase if configured
        if (firebaseConfig) {
          document.getElementById("firebaseApiKey").value =
            firebaseConfig.apiKey || "";
          document.getElementById("firebaseProjectId").value =
            firebaseConfig.projectId || "";
          await initializeFirebase(firebaseConfig);
        }

        // Initialize Lucide icons
        if (typeof lucide !== "undefined") {
          lucide.createIcons();
        }

        // Initialize swipe-down gesture for modals
        initSwipeGestures();
      }

      // Swipe gesture support
      function initSwipeGestures() {
        const modalConfigs = [
          { id: "addModal", overlay: "addModal" },
          { id: "viewModal", overlay: "viewModal" },
          { id: "categoriesModal", overlay: "categoriesModal" },
          { id: "settingsModal", overlay: "settingsModal" },
        ];

        modalConfigs.forEach((config) => {
          const overlayElement = document.getElementById(config.overlay);
          if (!overlayElement) return;

          const modalElement = overlayElement.querySelector(".modal");
          if (!modalElement) return;

          let touchStartY = 0;
          let touchCurrentY = 0;
          let isDragging = false;
          let startedOnHandle = false;

          modalElement.addEventListener(
            "touchstart",
            (e) => {
              // Check if touch started on modal handle or header
              const target = e.target;
              startedOnHandle =
                target.classList.contains("modal-handle") ||
                target.classList.contains("modal-header") ||
                target.closest(".modal-handle") ||
                target.closest(".modal-header");

              touchStartY = e.touches[0].clientY;
              touchCurrentY = touchStartY;
              isDragging = true;
            },
            { passive: true }
          );

          modalElement.addEventListener(
            "touchmove",
            (e) => {
              if (!isDragging || !startedOnHandle) return;
              touchCurrentY = e.touches[0].clientY;
              const diff = touchCurrentY - touchStartY;

              // Only allow dragging down
              if (diff > 0) {
                modalElement.style.transform = `translateY(${diff}px)`;
              }
            },
            { passive: true }
          );

          modalElement.addEventListener("touchend", () => {
            if (!isDragging) return;
            isDragging = false;

            const diff = touchCurrentY - touchStartY;
            const threshold = 80; // Swipe down more than 80px to close

            if (diff > threshold && startedOnHandle) {
              // Close the modal
              overlayElement.classList.remove("active");
              modalElement.style.transform = "";

              // Reset state based on modal type
              if (config.id === "viewModal") {
                viewingId = null;
              } else if (config.id === "addModal") {
                setTimeout(() => {
                  editingId = null;
                  document.getElementById("entryText").value = "";
                  document.getElementById("previewImage").style.display =
                    "none";
                  document.getElementById("imageUploadText").textContent =
                    "Add image";
                  selectedImage = null;
                  selectedColor = "#F3E874";
                  selectColor("#F3E874");
                }, 400);
              }
            } else {
              // Snap back
              modalElement.style.transform = "";
            }

            startedOnHandle = false;
          });
        });
      }

      // View Modal Functions
      function viewEntry(entryId) {
        viewingId = entryId;
        const entry = entries.find((e) => e.id === entryId);
        if (!entry) return;

        // Populate view modal
        document.getElementById("viewNoteText").textContent = entry.text;
        document.getElementById("viewDate").textContent = new Date(
          entry.date
        ).toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
        document.getElementById(
          "viewCategory"
        ).textContent = `${getCategoryEmoji(
          entry.category
        )} ${entry.category.toLowerCase()}`;

        const viewPostIt = document.getElementById("viewPostIt");
        viewPostIt.style.background = entry.color;

        // Add white-note class if the color is white
        if (entry.color.toUpperCase() === "#FFFFFF") {
          viewPostIt.classList.add("white-note");
        } else {
          viewPostIt.classList.remove("white-note");
        }

        // Handle image section
        const viewImgSection = document.getElementById("viewImageSection");
        const viewImg = document.getElementById("viewImage");
        if (entry.image) {
          viewImg.src = entry.image;
          viewImgSection.style.display = "block";
        } else {
          viewImgSection.style.display = "none";
        }

        document.getElementById("viewModal").classList.add("active");

        // Reinitialize icons after modal opens
        setTimeout(() => {
          if (typeof lucide !== "undefined") {
            lucide.createIcons();
          }
        }, 100);
      }

      function viewFullImage() {
        const img = document.getElementById("viewImage");
        if (!img.src) return;

        // Open image in new window/tab
        window.open(img.src, "_blank");
      }

      function closeViewModal() {
        document.getElementById("viewModal").classList.remove("active");
        viewingId = null;
      }

      function enterEditMode() {
        const idToEdit = viewingId; // Store the ID before closing
        closeViewModal();
        setTimeout(() => {
          openModal(idToEdit);
        }, 100); // Reduced timeout
      }

      function openModal(entryId = null) {
        editingId = entryId;

        if (entryId) {
          // Edit mode
          const entry = entries.find((e) => e.id === entryId);
          if (entry) {
            document.getElementById("modalTitle").textContent = "Edit note";
            document.getElementById("deleteBtn").classList.add("visible");
            document.getElementById("entryText").value = entry.text;
            document.getElementById("dateInput").value = new Date(entry.date)
              .toISOString()
              .split("T")[0];
            selectColor(entry.color);

            if (entry.image) {
              selectedImage = entry.image;
              const img = document.getElementById("previewImage");
              img.src = entry.image;
              img.style.display = "block";
              document.getElementById("imageUploadText").textContent =
                "Change image";
            } else {
              selectedImage = null;
              document.getElementById("previewImage").style.display = "none";
              document.getElementById("imageUploadText").textContent =
                "Add image";
            }
          }
        } else {
          // New mode
          document.getElementById("modalTitle").textContent = "New moment";
          document.getElementById("deleteBtn").classList.remove("visible");
          document.getElementById("entryText").value = "";
          selectedImage = null;
          document.getElementById("previewImage").style.display = "none";
          document.getElementById("imageUploadText").textContent = "Add image";
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("dateInput").value = today;
          selectColor("#F3E874");
        }

        document.getElementById("addModal").classList.add("active");
        setTimeout(() => {
          document.getElementById("entryText").focus();
        }, 300);
      }

      function closeModal() {
        document.getElementById("addModal").classList.remove("active");
        setTimeout(() => {
          editingId = null;
          document.getElementById("entryText").value = "";
          document.getElementById("previewImage").style.display = "none";
          document.getElementById("imageUploadText").textContent = "Add image";
          selectedImage = null;
          selectedColor = "#F3E874";
          selectColor("#F3E874");
        }, 400);
      }

      function handleOverlayClick(event) {
        if (event.target.classList.contains("modal-overlay")) {
          event.target.classList.remove("active");
        }
      }

      function selectColor(color) {
        selectedColor = color;
        document.getElementById("notePreview").style.background = color;
        document.querySelectorAll(".color-option").forEach((el) => {
          el.classList.remove("selected");
          if (el.style.background === color) {
            el.classList.add("selected");
          }
        });
      }

      function compressImage(file, maxWidth = 800, quality = 0.7) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              // Calculate new dimensions
              let width = img.width;
              let height = img.height;

              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }

              // Create canvas and compress
              const canvas = document.createElement("canvas");
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, width, height);

              // Convert to compressed base64
              const compressedDataUrl = canvas.toDataURL("image/jpeg", quality);
              resolve(compressedDataUrl);
            };
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
          try {
            // Compress image before storing
            selectedImage = await compressImage(file, 800, 0.7);
            const img = document.getElementById("previewImage");
            img.src = selectedImage;
            img.style.display = "block";
            document.getElementById("imageUploadText").textContent =
              "Change image";
          } catch (error) {
            console.error("Error compressing image:", error);
            alert("Failed to process image. Please try a different image.");
          }
        }
      }

      async function saveEntry() {
        const text = document.getElementById("entryText").value.trim();
        if (!text) return;

        // Show loading state
        const saveBtn = document.querySelector(".header-save-btn");
        const originalText = saveBtn.innerHTML;
        const loadingMessage = apiKey ? "Categorizing..." : "Saving...";

        saveBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 6v6l4 2"></path>
                </svg>
                ${loadingMessage}
              `;
        saveBtn.disabled = true;

        try {
          const dateInput = document.getElementById("dateInput").value;
          const selectedDate = dateInput
            ? new Date(dateInput + "T12:00:00")
            : new Date();

          // Get category (with AI if available)
          const category = await categorizeEntry(text);

          let entry;
          if (editingId) {
            // Update existing entry
            const existingEntry = entries.find((e) => e.id === editingId);
            if (!existingEntry) {
              console.error("Entry not found:", editingId);
              throw new Error("Entry not found. Please refresh and try again.");
            }
            entry = {
              id: existingEntry.id,
              text,
              color: selectedColor,
              image: selectedImage,
              category: category,
              date: selectedDate.toISOString(),
            };
          } else {
            // Create new entry
            entry = {
              id: Date.now(),
              text,
              color: selectedColor,
              image: selectedImage,
              category: category,
              date: selectedDate.toISOString(),
            };
          }

          // Save to Firebase (or localStorage as fallback)
          await saveEntryToFirebase(entry);

          // If not using Firebase sync, manually update UI
          if (!db || !currentUser) {
            renderEntries();
            updateCategoriesButton();
          }

          closeModal();
        } catch (error) {
          console.error("Error saving entry:", error);

          // Check if it's a quota exceeded error
          if (
            error.name === "QuotaExceededError" ||
            error.message.includes("quota")
          ) {
            alert(
              "Storage limit exceeded! Your images are too large.\n\nTip: Try removing images from older notes or use smaller photos."
            );
          } else {
            alert(
              `Failed to save entry: ${error.message || "Please try again."}`
            );
          }
        } finally {
          // Always restore button
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
        }
      }

      async function deleteEntry() {
        if (!editingId) return;

        if (
          confirm(
            "⚠️ Delete this entry?\n\nThis will permanently delete your note and cannot be undone.\n\nAre you sure you want to continue?"
          )
        ) {
          // Delete from Firebase (or localStorage as fallback)
          await deleteEntryFromFirebase(editingId);

          // If not using Firebase sync, manually update UI
          if (!db || !currentUser) {
            renderEntries();
            updateCategoriesButton();
          }

          closeModal();
        }
      }

      function renderEntries() {
        const grid = document.getElementById("grid");
        const empty = document.getElementById("emptyState");

        if (entries.length === 0) {
          grid.style.display = "none";
          empty.style.display = "flex";
          return;
        }

        empty.style.display = "none";
        grid.style.display = "grid";

        // Sort by date descending (newest first) for grid layout - newest top-left, oldest bottom-right
        const sortedEntries = [...entries].sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );

        console.log(
          `Rendering ${sortedEntries.length} entries:`,
          sortedEntries.map((e) => ({
            id: e.id,
            date: e.date,
            text: e.text.substring(0, 20),
          }))
        );

        grid.innerHTML = sortedEntries
          .map((entry, idx) => {
            if (!entry || !entry.id || !entry.text || !entry.color) {
              console.warn("Invalid entry skipped:", entry);
              return "";
            }
            return `
                      <div class="post-it" style="background: ${
                        entry.color
                      }; animation-delay: ${idx * 0.05}s" onclick="viewEntry(${
              entry.id
            })">
                          ${
                            entry.image
                              ? `<img src="${entry.image}" class="post-it-image">`
                              : ""
                          }
                          <div class="post-it-footer">
                              <span>${new Date(entry.date).toLocaleDateString(
                                "en-US",
                                {
                                  month: "short",
                                  day: "numeric",
                                  year: "numeric",
                                }
                              )}</span>
                              <span class="post-it-category">${getCategoryEmoji(
                                entry.category
                              )} ${entry.category.toLowerCase()}</span>
                          </div>
                          <div class="post-it-text">${entry.text}</div>
                      </div>
                    `;
          })
          .join("");
      }

      function updateCategoriesButton() {
        const btn = document.getElementById("categoriesBtn");
        if (entries.length >= 5) {
          btn.classList.add("visible");
        } else {
          btn.classList.remove("visible");
        }
      }

      async function showCategories() {
        const grouped = {};
        entries.forEach((e) => {
          if (!grouped[e.category]) grouped[e.category] = [];
          grouped[e.category].push(e);
        });

        const sorted = Object.entries(grouped).sort(
          (a, b) => b[1].length - a[1].length
        );
        const content = document.getElementById("categoriesContent");

        // Show loading state
        content.innerHTML =
          '<div style="padding: 40px; text-align: center; color: var(--color-text-secondary);">Generating insights...</div>';
        document.getElementById("categoriesModal").classList.add("active");

        // Generate summaries (with AI if available)
        const categoriesHTML = await Promise.all(
          sorted.map(async ([cat, items]) => {
            const summary = await generateCategorySummary(cat, items);
            return `
                          <div class="category-group">
                              <div class="category-header">
                                  <h3 class="category-name">${getCategoryEmoji(
                                    cat
                                  )} ${cat.toLowerCase()}</h3>
                                  <span class="category-count">${
                                    items.length
                                  }</span>
                              </div>
                              <div class="category-summary">
                                  ${summary}
                              </div>
                              <div class="grid">
                                  ${items
                                    .map(
                                      (e) => `
                                      <div class="post-it" style="background: ${
                                        e.color
                                      }" onclick="closeCategoriesModal(); viewEntry(${
                                        e.id
                                      });">
                                          ${
                                            e.image
                                              ? `<img src="${e.image}" class="post-it-image">`
                                              : ""
                                          }
                                          <div class="post-it-footer">
                                              <span>${new Date(
                                                e.date
                                              ).toLocaleDateString("en-US", {
                                                month: "short",
                                                day: "numeric",
                                              })}</span>
                                              <span class="post-it-category">${getCategoryEmoji(
                                                e.category
                                              )} ${e.category.toLowerCase()}</span>
                                          </div>
                                          <div class="post-it-text">${
                                            e.text
                                          }</div>
                                      </div>
                                  `
                                    )
                                    .join("")}
                              </div>
                          </div>
                      `;
          })
        );

        content.innerHTML = categoriesHTML.join("");
      }

      function closeCategoriesModal() {
        document.getElementById("categoriesModal").classList.remove("active");
      }

      init();

      // Register service worker for PWA
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((reg) => console.log("Service Worker registered"))
            .catch((err) => console.log("Service Worker registration failed"));
        });
      }
    </script>
  </body>
</html>
